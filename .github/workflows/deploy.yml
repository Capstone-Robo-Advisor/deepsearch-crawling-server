name: Deploy Deepsearch Crawler to EC2

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Connect and deploy to EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "ğŸ” [$(date)] ë°°í¬ ì‹œì‘"

            # 1. ë””ë ‰í† ë¦¬ ì—†ìœ¼ë©´ clone, ìˆìœ¼ë©´ pull
            if [ ! -d "/home/ubuntu/deepsearch-crawling-server" ]; then
              git clone https://github.com/Capstone-Robo-Advisor/deepsearch-crawling-server.git /home/ubuntu/deepsearch-crawling-server
            else
              cd /home/ubuntu/deepsearch-crawling-server
              git fetch origin main
              git reset --hard origin/main
              git clean -fd
            fi

            cd /home/ubuntu/deepsearch-crawling-server

            # 2. Docker ë¹Œë“œ
            docker build -t deepsearch-crawler:latest .

            # 3. ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸ ìƒì„± ë˜ëŠ” ê°±ì‹ 
            cat > /home/ubuntu/run-deepsearch.sh << 'EOL'
            #!/bin/bash
            LOG_FILE="/var/log/deepsearch/deepsearch-$(date +\%Y-\%m-\%d).log"
            echo "ğŸŸ¢ ì‹¤í–‰ ì‹œì‘ at \$(date)" >> $LOG_FILE
            docker run --rm --env-file /home/ubuntu/deepsearch.env deepsearch-crawler:latest >> $LOG_FILE 2>&1
            echo "ğŸ”š ì‹¤í–‰ ì™„ë£Œ at \$(date)" >> $LOG_FILE
            EOL

            chmod +x /home/ubuntu/run-deepsearch.sh

            # 4. ë¡œê·¸ ë””ë ‰í† ë¦¬ ìƒì„±
            mkdir -p /var/log/deepsearch

            echo "âœ… ë°°í¬ ì™„ë£Œ [$(date)]"
